<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CertificaDApp - Simulação Local</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .header h1 {
            color: #4C51BF;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .user-selector {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .user-selector h2 {
            color: #4C51BF;
            margin-bottom: 15px;
        }

        .user-btn {
            background: linear-gradient(135deg, #4C51BF, #667eea);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 81, 191, 0.4);
        }

        .user-btn.active {
            background: linear-gradient(135deg, #48BB78, #38A169);
        }

        .current-user {
            background: linear-gradient(135deg, #2D3748, #4A5568);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-user h3 {
            margin-bottom: 5px;
        }

        .address {
            font-family: monospace;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 5px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .card h2 {
            color: #4C51BF;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            background: linear-gradient(135deg, #4C51BF, #667eea);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn.danger {
            background: linear-gradient(135deg, #E53E3E, #C53030);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .certificate-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .certificate-card h4 {
            color: #2D3748;
            margin-bottom: 8px;
        }

        .info-item {
            margin: 5px 0;
            font-size: 14px;
        }

        .info-item strong {
            color: #2D3748;
        }

        .balance-display {
            background: linear-gradient(135deg, #48BB78, #38A169);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
        }

        .balance-display h3 {
            margin-bottom: 5px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 CertificaDApp - Simulação Local</h1>
            <p>Sistema de Certificados Digitais com Tokens CTK (Sem MetaMask)</p>
        </div>

        <div class="user-selector">
            <h2>👥 Selecione o Usuário</h2>
            <button class="user-btn" onclick="selectUser('admin')">👨‍🏫 Professor/Admin</button>
            <button class="user-btn" onclick="selectUser('aluno1')">👨‍🎓 Aluno 1</button>
            <button class="user-btn" onclick="selectUser('aluno2')">👩‍🎓 Aluno 2</button>
        </div>

        <div id="userInfo" class="current-user hidden">
            <h3 id="userName"></h3>
            <div class="address" id="userAddress"></div>
            <div class="balance-display">
                <h3>💰 Saldo CTK</h3>
                <div id="tokenBalance">0 CTK</div>
            </div>
        </div>

        <div id="appContent" class="hidden">
            <!-- Admin Panel -->
            <div id="adminPanel" class="hidden">
                <div class="card">
                    <h2>👨‍🏫 Painel do Professor</h2>
                    <div class="input-group">
                        <label>Selecionar Aluno:</label>
                        <select id="selectAluno">
                            <option value="">Escolha um aluno...</option>
                            <option value="0x70997970C51812dc3A010C7d01b50e0d17dc79C8">👨‍🎓 Aluno 1</option>
                            <option value="0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC">👩‍🎓 Aluno 2</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Nome do Aluno:</label>
                        <input type="text" id="alunoNome" placeholder="João da Silva">
                    </div>
                    <div class="input-group">
                        <label>Nome do Curso:</label>
                        <input type="text" id="cursoNome" placeholder="Blockchain Básico">
                    </div>
                    <div class="input-group">
                        <label>Data de Conclusão:</label>
                        <input type="date" id="cursoData">
                    </div>
                    <div class="input-group">
                        <label>ID do Certificado:</label>
                        <input type="text" id="certificadoId" placeholder="CERT001">
                    </div>
                    <button class="btn" onclick="emitirCertificado()">📜 Emitir Certificado + 10 CTK</button>
                </div>
            </div>

            <!-- Student Panel -->
            <div id="studentPanel" class="hidden">
                <div class="grid">
                    <div class="card">
                        <h2>📜 Meus Certificados</h2>
                        <button class="btn" onclick="consultarCertificados()">Consultar Certificados</button>
                        <div id="certificadosResult"></div>
                    </div>

                    <div class="card">
                        <h2>💸 Transferir CTK</h2>
                        <div class="input-group">
                            <label>Para quem transferir:</label>
                            <select id="transferPara">
                                <option value="">Escolha...</option>
                                <option value="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266">👨‍🏫 Professor</option>
                                <option value="0x70997970C51812dc3A010C7d01b50e0d17dc79C8">👨‍🎓 Aluno 1</option>
                                <option value="0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC">👩‍🎓 Aluno 2</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Quantidade CTK:</label>
                            <input type="number" id="quantidadeTransfer" placeholder="5" min="1">
                        </div>
                        <button class="btn" onclick="transferirTokens()">💸 Transferir</button>
                    </div>
                </div>
            </div>

            <!-- Verification Panel (Available to all) -->
            <div class="card">
                <h2>🔍 Verificar Certificado</h2>
                <div class="input-group">
                    <label>ID do Certificado:</label>
                    <input type="text" id="verificarId" placeholder="CERT001">
                </div>
                <button class="btn" onclick="verificarCertificado()">🔍 Verificar Autenticidade</button>
                <div id="verificacaoResult"></div>
            </div>
        </div>

        <div id="statusMessages"></div>

        <!-- Quick Actions -->
        <div id="quickActions" class="card hidden">
            <h2>⚡ Ações Rápidas (Para Demonstração)</h2>
            <button class="btn" onclick="exemploCompleto()">🎯 Exemplo Completo</button>
            <button class="btn danger" onclick="limparDados()">🗑️ Limpar Dados</button>
        </div>
    </div>

    <script>
        // Endereços dos contratos (serão atualizados dinamicamente)
        let CERTIFICADOS_ADDRESS = "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0";
        let CERTITOKEN_ADDRESS = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";

        // Contas locais do Hardhat
        const ACCOUNTS = {
            admin: {
                address: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
                name: "👨‍🏫 Professor/Admin",
                privateKey: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
            },
            aluno1: {
                address: "0x70997970C51812dc3A010C7d01b50e0d17dc79C8",
                name: "👨‍🎓 Aluno 1",
                privateKey: "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"
            },
            aluno2: {
                address: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC",
                name: "👩‍🎓 Aluno 2", 
                privateKey: "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
            }
        };

        // ABIs completos dos contratos
        const CERTIFICADOS_ABI = [
            "function admin() view returns (address)",
            "function certiToken() view returns (address)",
            "function emitir(address aluno, string nome, string curso, string data, string id)",
            "function consultar(address aluno) view returns (tuple(string nome, string curso, string data, string id, bool ativo)[])",
            "function verificar(string id) view returns (bool)",
            "function detalhes(string id) view returns (string nome, string curso, string data, address aluno, bool ativo)",
            "function saldoTokens(address aluno) view returns (uint256)",
            "function totalCertificados(address aluno) view returns (uint256)",
            "event CertificadoEmitido(address indexed aluno, string nome, string curso, string id)",
            "event TokenRecompensa(address indexed aluno, uint256 quantidade)"
        ];

        const CERTITOKEN_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address account) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function transferFrom(address from, address to, uint256 amount) returns (bool)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function recompensar(address aluno, uint256 quantidade)",
            "function destruirTokens(uint256 quantidade)",
            "function destruirMeusTokens(uint256 quantidade)",
            "function owner() view returns (address)",
            "event Transfer(address indexed from, address indexed to, uint256 value)",
            "event Approval(address indexed owner, address indexed spender, uint256 value)"
        ];

        let provider, currentUser, currentWallet, certificadosContract, certiTokenContract;

        // Inicializar provider local com retry
        async function initProvider() {
            try {
                provider = new ethers.providers.JsonRpcProvider("http://127.0.0.1:8545");
                
                // Testar conexão
                const network = await provider.getNetwork();
                console.log("🌐 Conectado à rede:", network.name, "Chain ID:", network.chainId);
                
                return true;
            } catch (error) {
                console.error("❌ Erro ao conectar ao provider:", error);
                showStatus("❌ Erro ao conectar à blockchain local. Verifique se o Hardhat está rodando.", 'error');
                return false;
            }
        }

        // Selecionar usuário
        async function selectUser(userType) {
            const connected = await initProvider();
            if (!connected) return;
            
            currentUser = ACCOUNTS[userType];
            currentWallet = new ethers.Wallet(currentUser.privateKey, provider);

            // Inicializar contratos
            try {
                certificadosContract = new ethers.Contract(CERTIFICADOS_ADDRESS, CERTIFICADOS_ABI, currentWallet);
                certiTokenContract = new ethers.Contract(CERTITOKEN_ADDRESS, CERTITOKEN_ABI, currentWallet);

                // Testar se os contratos estão funcionando
                await certificadosContract.admin();
                await certiTokenContract.name();
                
                console.log("✅ Contratos inicializados com sucesso");
            } catch (error) {
                console.error("❌ Erro ao inicializar contratos:", error);
                showStatus("❌ Erro ao conectar aos contratos. Verifique se foram deployados corretamente.", 'error');
                return;
            }

            // Atualizar UI
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAddress').textContent = currentUser.address;
            
            // Mostrar painel apropriado
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('quickActions').classList.remove('hidden');

            // Esconder/mostrar painéis específicos
            document.getElementById('adminPanel').classList.toggle('hidden', userType !== 'admin');
            document.getElementById('studentPanel').classList.toggle('hidden', userType === 'admin');

            // Destacar botão ativo
            document.querySelectorAll('.user-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Atualizar saldo
            await updateBalance();

            showStatus(`✅ Conectado como ${currentUser.name}`, 'success');
        }

        // Atualizar saldo de tokens
        async function updateBalance() {
            try {
                const balance = await certiTokenContract.balanceOf(currentUser.address);
                const formattedBalance = ethers.utils.formatEther(balance);
                document.getElementById('tokenBalance').textContent = `${parseFloat(formattedBalance).toFixed(2)} CTK`;
            } catch (error) {
                console.error('Erro ao consultar saldo:', error);
                document.getElementById('tokenBalance').textContent = "Erro ao carregar";
            }
        }

        // Emitir certificado (apenas admin)
        async function emitirCertificado() {
            const alunoAddress = document.getElementById('selectAluno').value;
            const nome = document.getElementById('alunoNome').value;
            const curso = document.getElementById('cursoNome').value;
            const data = document.getElementById('cursoData').value;
            const id = document.getElementById('certificadoId').value;

            if (!alunoAddress || !nome || !curso || !data || !id) {
                showStatus('❌ Preencha todos os campos!', 'error');
                return;
            }

            try {
                showStatus('⏳ Emitindo certificado...', 'info');
                const tx = await certificadosContract.emitir(alunoAddress, nome, curso, data, id);
                await tx.wait();
                
                showStatus(`✅ Certificado ${id} emitido para ${nome}! Aluno recebeu 10 CTK.`, 'success');
                
                // Limpar campos
                document.getElementById('selectAluno').value = '';
                document.getElementById('alunoNome').value = '';
                document.getElementById('cursoNome').value = '';
                document.getElementById('cursoData').value = '';
                document.getElementById('certificadoId').value = '';

            } catch (error) {
                showStatus('❌ Erro: ' + error.message, 'error');
            }
        }

        // Consultar certificados do usuário atual
        async function consultarCertificados() {
            console.log("Usuário atual:", currentUser);
            try {
                const certificados = await certificadosContract.consultar(currentUser.address);
                const resultDiv = document.getElementById('certificadosResult');
                
                if (certificados.length === 0) {
                    resultDiv.innerHTML = '<p>📭 Você ainda não possui certificados.</p>';
                    return;
                }

                let html = '<h3>📜 Seus Certificados:</h3>';
                certificados.forEach((cert, index) => {
                    html += `
                        <div class="certificate-card">
                            <h4>🎓 Certificado #${index + 1}</h4>
                            <div class="info-item"><strong>Nome:</strong> ${cert.nome}</div>
                            <div class="info-item"><strong>Curso:</strong> ${cert.curso}</div>
                            <div class="info-item"><strong>Data:</strong> ${cert.data}</div>
                            <div class="info-item"><strong>ID:</strong> ${cert.id}</div>
                            <div class="info-item"><strong>Status:</strong> ${cert.ativo ? '✅ Ativo' : '❌ Inativo'}</div>
                        </div>
                    `;
                });
                
                resultDiv.innerHTML = html;

            } catch (error) {
                console.error('Erro detalhado:', error);
                showStatus('❌ Erro ao consultar certificados: ' + error.message, 'error');
            }
        }

        // Verificar certificado por ID
        async function verificarCertificado() {
            const id = document.getElementById('verificarId').value;
            if (!id) {
                showStatus('❌ Digite o ID do certificado!', 'error');
                return;
            }

            try {
                const existe = await certificadosContract.verificar(id);
                const resultDiv = document.getElementById('verificacaoResult');
                
                if (existe) {
                    const detalhes = await certificadosContract.detalhes(id);
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>✅ Certificado Válido!</strong><br>
                            <strong>Nome:</strong> ${detalhes[0]}<br>
                            <strong>Curso:</strong> ${detalhes[1]}<br>
                            <strong>Data:</strong> ${detalhes[2]}<br>
                            <strong>Aluno:</strong> ${detalhes[3]}<br>
                            <strong>Status:</strong> ${detalhes[4] ? 'Ativo' : 'Inativo'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            <strong>❌ Certificado não encontrado!</strong><br>
                            Este ID não corresponde a nenhum certificado válido.
                        </div>
                    `;
                }
            } catch (error) {
                showStatus('❌ Erro ao verificar: ' + error.message, 'error');
            }
        }

        // Transferir tokens
        async function transferirTokens() {
            const para = document.getElementById('transferPara').value;
            const quantidade = document.getElementById('quantidadeTransfer').value;

            if (!para || !quantidade) {
                showStatus('❌ Preencha todos os campos!', 'error');
                return;
            }

            try {
                showStatus('⏳ Transferindo tokens...', 'info');
                const amount = ethers.utils.parseEther(quantidade);
                const tx = await certiTokenContract.transfer(para, amount);
                await tx.wait();
                
                showStatus(`✅ ${quantidade} CTK transferidos com sucesso!`, 'success');
                await updateBalance();
                
                // Limpar campos
                document.getElementById('transferPara').value = '';
                document.getElementById('quantidadeTransfer').value = '';

            } catch (error) {
                showStatus('❌ Erro na transferência: ' + error.message, 'error');
            }
        }

        // Exemplo completo para demonstração
        async function exemploCompleto() {
            showStatus('🎯 Executando exemplo completo...', 'info');
            
            // Simular como admin
            const adminWallet = new ethers.Wallet(ACCOUNTS.admin.privateKey, provider);
            const adminCertificados = new ethers.Contract(CERTIFICADOS_ADDRESS, CERTIFICADOS_ABI, adminWallet);
            
            try {
                // Emitir certificado para aluno1
                await adminCertificados.emitir(
                    ACCOUNTS.aluno1.address,
                    "João da Silva", 
                    "Blockchain Avançado",
                    "2025-01-15",
                    "DEMO001"
                );

                showStatus('✅ Exemplo concluído! Certificado DEMO001 emitido para Aluno 1.', 'success');
                
            } catch (error) {
                showStatus('❌ Erro no exemplo: ' + error.message, 'error');
            }
        }

        // Limpar dados de exemplo
        function limparDados() {
            document.getElementById('certificadosResult').innerHTML = '';
            document.getElementById('verificacaoResult').innerHTML = '';
            showStatus('🗑️ Dados da interface limpos!', 'info');
        }

        // Mostrar mensagens de status
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessages');
            const statusEl = document.createElement('div');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
            
            statusDiv.appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.remove();
            }, 5000);
        }

        // Definir data padrão
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('cursoData').value = hoje;
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html>
<head>
    <title>CertificaDApp Local</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body { font-family: Arial; margin: 20px; background: #f0f0f0; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { background: white; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 20px; }
        .user-panel { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .btn { background: #4C51BF; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #3C41A6; }
        .btn.active { background: #48BB78; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .cert-card { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .hidden { display: none; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì CertificaDApp - Simula√ß√£o Local</h1>
            <p>Sistema de Certificados Digitais + Tokens CTK</p>
        </div>

        <div class="user-panel">
            <h2>Usu√°rio:</h2>
            <button class="btn" onclick="selectUser('admin')">üë®‚Äçüè´ Professor</button>
            <button class="btn" onclick="selectUser('aluno1')">üë®‚Äçüéì Aluno 1</button>
            <button class="btn" onclick="selectUser('aluno2')">üë©‚Äçüéì Aluno 2</button>
        </div>

        <div id="userInfo" class="card hidden">
            <h3 id="userName"></h3>
            <p id="userAddress" style="font-family: monospace; font-size: 12px;"></p>
            <p><strong>Saldo CTK:</strong> <span id="tokenBalance">0</span></p>
        </div>

        <div id="appContent" class="hidden">
            <!-- PROFESSOR -->
            <div id="adminPanel" class="card hidden">
                <h2>üë®‚Äçüè´ Emitir Certificado</h2>
                <div class="input-group">
                    <label>Aluno:</label>
                    <select id="selectAluno">
                        <option value="">Escolha...</option>
                        <option value="0x70997970C51812dc3A010C7d01b50e0d17dc79C8">Aluno 1</option>
                        <option value="0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC">Aluno 2</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Nome:</label>
                    <input type="text" id="alunoNome" placeholder="Jo√£o Silva">
                </div>
                <div class="input-group">
                    <label>Curso:</label>
                    <input type="text" id="cursoNome" placeholder="Blockchain">
                </div>
                <div class="input-group">
                    <label>Data:</label>
                    <input type="date" id="cursoData">
                </div>
                <div class="input-group">
                    <label>ID:</label>
                    <input type="text" id="certificadoId" placeholder="CERT001">
                </div>
                <button class="btn" onclick="emitirCertificado()">Emitir + 10 CTK</button>
            </div>

            <!-- ALUNOS -->
            <div id="studentPanel" class="hidden">
                <div class="grid">
                    <div class="card">
                        <h2>üìú Meus Certificados</h2>
                        <button class="btn" onclick="consultarCertificados()">Ver Certificados</button>
                        <div id="certificadosResult"></div>
                    </div>
                    <div class="card">
                        <h2>üí∏ Transferir CTK</h2>
                        <div class="input-group">
                            <label>Para:</label>
                            <select id="transferPara">
                                <option value="">Escolha...</option>
                                <option value="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266">Professor</option>
                                <option value="0x70997970C51812dc3A010C7d01b50e0d17dc79C8">Aluno 1</option>
                                <option value="0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC">Aluno 2</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Quantidade:</label>
                            <input type="number" id="quantidadeTransfer" placeholder="5">
                        </div>
                        <button class="btn" onclick="transferirTokens()">Transferir</button>
                    </div>
                </div>
            </div>

            <!-- VERIFICA√á√ÉO -->
            <div class="card">
                <h2>üîç Verificar Certificado</h2>
                <div class="input-group">
                    <label>ID:</label>
                    <input type="text" id="verificarId" placeholder="CERT001">
                </div>
                <button class="btn" onclick="verificarCertificado()">Verificar</button>
                <div id="verificacaoResult"></div>
            </div>
        </div>

        <div id="statusMessages"></div>
    </div>

    <script>
        const CERTIFICADOS_ADDRESS = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";
        const CERTITOKEN_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";

        const ACCOUNTS = {
            admin: {
                address: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
                name: "Professor",
                privateKey: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
            },
            aluno1: {
                address: "0x70997970C51812dc3A010C7d01b50e0d17dc79C8",
                name: "Aluno 1",
                privateKey: "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"
            },
            aluno2: {
                address: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC",
                name: "Aluno 2",
                privateKey: "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
            }
        };

        const CERTIFICADOS_ABI = [
            "function emitir(address aluno, string nome, string curso, string data, string id)",
            "function consultar(address aluno) view returns (tuple(string nome, string curso, string data, string id, bool ativo)[])",
            "function verificar(string id) view returns (bool)",
            "function detalhes(string id) view returns (string nome, string curso, string data, address aluno, bool ativo)"
        ];

        const CERTITOKEN_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)"
        ];

        let provider, currentUser, currentWallet, certificadosContract, certiTokenContract;

        async function selectUser(userType) {
            provider = new ethers.providers.JsonRpcProvider("http://127.0.0.1:8545");
            currentUser = ACCOUNTS[userType];
            currentWallet = new ethers.Wallet(currentUser.privateKey, provider);

            certificadosContract = new ethers.Contract(CERTIFICADOS_ADDRESS, CERTIFICADOS_ABI, currentWallet);
            certiTokenContract = new ethers.Contract(CERTITOKEN_ADDRESS, CERTITOKEN_ABI, currentWallet);

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAddress').textContent = currentUser.address;
            
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.getElementById('adminPanel').classList.toggle('hidden', userType !== 'admin');
            document.getElementById('studentPanel').classList.toggle('hidden', userType === 'admin');

            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            await updateBalance();
            showStatus(`Conectado como ${currentUser.name}`, 'success');
        }

        async function updateBalance() {
            try {
                const balance = await certiTokenContract.balanceOf(currentUser.address);
                const formatted = ethers.utils.formatEther(balance);
                document.getElementById('tokenBalance').textContent = parseFloat(formatted).toFixed(2);
            } catch (error) {
                console.error('Erro saldo:', error);
            }
        }

        async function emitirCertificado() {
            const alunoAddress = document.getElementById('selectAluno').value;
            const nome = document.getElementById('alunoNome').value;
            const curso = document.getElementById('cursoNome').value;
            const data = document.getElementById('cursoData').value;
            const id = document.getElementById('certificadoId').value;

            if (!alunoAddress || !nome || !curso || !data || !id) {
                showStatus('Preencha todos os campos!', 'error');
                return;
            }

            try {
                showStatus('Emitindo certificado...', 'info');
                const tx = await certificadosContract.emitir(alunoAddress, nome, curso, data, id);
                await tx.wait();
                showStatus(`Certificado ${id} emitido! Aluno ganhou 10 CTK.`, 'success');
                
                // Limpar
                document.getElementById('selectAluno').value = '';
                document.getElementById('alunoNome').value = '';
                document.getElementById('cursoNome').value = '';
                document.getElementById('certificadoId').value = '';
            } catch (error) {
                showStatus('Erro: ' + error.message, 'error');
            }
        }

        async function consultarCertificados() {
            try {
                const certificados = await certificadosContract.consultar(currentUser.address);
                const resultDiv = document.getElementById('certificadosResult');
                
                if (certificados.length === 0) {
                    resultDiv.innerHTML = '<p>Nenhum certificado.</p>';
                    return;
                }

                let html = '<h3>Certificados:</h3>';
                certificados.forEach((cert, index) => {
                    html += `
                        <div class="cert-card">
                            <h4>Certificado ${index + 1}</h4>
                            <p><strong>Nome:</strong> ${cert.nome}</p>
                            <p><strong>Curso:</strong> ${cert.curso}</p>
                            <p><strong>Data:</strong> ${cert.data}</p>
                            <p><strong>ID:</strong> ${cert.id}</p>
                            <p><strong>Status:</strong> ${cert.ativo ? 'Ativo' : 'Inativo'}</p>
                        </div>
                    `;
                });
                resultDiv.innerHTML = html;
            } catch (error) {
                showStatus('Erro: ' + error.message, 'error');
            }
        }

        async function verificarCertificado() {
            const id = document.getElementById('verificarId').value;
            if (!id) {
                showStatus('Digite o ID!', 'error');
                return;
            }

            try {
                const existe = await certificadosContract.verificar(id);
                const resultDiv = document.getElementById('verificacaoResult');
                
                if (existe) {
                    const detalhes = await certificadosContract.detalhes(id);
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>‚úÖ Certificado V√°lido!</strong><br>
                            Nome: ${detalhes[0]}<br>
                            Curso: ${detalhes[1]}<br>
                            Data: ${detalhes[2]}<br>
                            Aluno: ${detalhes[3]}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="status error">‚ùå Certificado n√£o encontrado!</div>';
                }
            } catch (error) {
                showStatus('Erro: ' + error.message, 'error');
            }
        }

        async function transferirTokens() {
            const para = document.getElementById('transferPara').value;
            const quantidade = document.getElementById('quantidadeTransfer').value;

            if (!para || !quantidade) {
                showStatus('Preencha os campos!', 'error');
                return;
            }

            try {
                showStatus('Transferindo...', 'info');
                const amount = ethers.utils.parseEther(quantidade);
                const tx = await certiTokenContract.transfer(para, amount);
                await tx.wait();
                
                showStatus(`${quantidade} CTK transferidos!`, 'success');
                await updateBalance();
                
                document.getElementById('transferPara').value = '';
                document.getElementById('quantidadeTransfer').value = '';
            } catch (error) {
                showStatus('Erro: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessages');
            const statusEl = document.createElement('div');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
            statusDiv.appendChild(statusEl);
            setTimeout(() => statusEl.remove(), 4000);
        }

        // Data padr√£o
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date().toISOString().split('T')[0];
            if (document.getElementById('cursoData')) {
                document.getElementById('cursoData').value = hoje;
            }
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CertificaDApp - Local</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #4C51BF;
            margin: 0;
        }
        .user-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .user-btn {
            background: #4C51BF;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .user-btn:hover {
            background: #3C41A6;
        }
        .user-btn.active {
            background: #48BB78;
        }
        .current-user {
            background: #2D3748;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: #4C51BF;
            margin-top: 0;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .btn {
            background: #4C51BF;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #3C41A6;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .certificate-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        .balance-display {
            background: #48BB78;
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì CertificaDApp - Simula√ß√£o Local</h1>
            <p>Sistema de Certificados com Tokens CTK</p>
        </div>

        <div class="user-selector">
            <h2>Selecione o Usu√°rio:</h2>
            <button class="user-btn" onclick="selectUser('admin')">üë®‚Äçüè´ Professor</button>
            <button class="user-btn" onclick="selectUser('aluno1')">üë®‚Äçüéì Aluno 1</button>
            <button class="user-btn" onclick="selectUser('aluno2')">üë©‚Äçüéì Aluno 2</button>
        </div>

        <div id="userInfo" class="current-user hidden">
            <h3 id="userName"></h3>
            <div id="userAddress" style="font-family: monospace; font-size: 12px;"></div>
            <div class="balance-display">
                <h3>üí∞ Saldo: <span id="tokenBalance">0</span> CTK</h3>
            </div>
        </div>

        <div id="appContent" class="hidden">
            <!-- PAINEL DO PROFESSOR -->
            <div id="adminPanel" class="hidden">
                <div class="card">
                    <h2>üë®‚Äçüè´ Emitir Certificado</h2>
                    <div class="input-group">
                        <label>Aluno:</label>
                        <select id="selectAluno">
                            <option value="">Escolha...</option>
                            <option value="0x70997970C51812dc3A010C7d01b50e0d17dc79C8">üë®‚Äçüéì Aluno 1</option>
                            <option value="0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC">üë©‚Äçüéì Aluno 2</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Nome:</label>
                        <input type="text" id="alunoNome" placeholder="Jo√£o da Silva">
                    </div>
                    <div class="input-group">
                        <label>Curso:</label>
                        <input type="text" id="cursoNome" placeholder="Blockchain B√°sico">
                    </div>
                    <div class="input-group">
                        <label>Data:</label>
                        <input type="date" id="cursoData">
                    </div>
                    <div class="input-group">
                        <label>ID Certificado:</label>
                        <input type="text" id="certificadoId" placeholder="CERT001">
                    </div>
                    <button class="btn" onclick="emitirCertificado()">üìú Emitir + 10 CTK</button>
                </div>
            </div>

            <!-- PAINEL DOS ALUNOS -->
            <div id="studentPanel" class="hidden">
                <div class="grid">
                    <div class="card">
                        <h2>üìú Meus Certificados</h2>
                        <button class="btn" onclick="consultarCertificados()">Ver Certificados</button>
                        <div id="certificadosResult"></div>
                    </div>
                    <div class="card">
                        <h2>üí∏ Transferir CTK</h2>
                        <div class="input-group">
                            <label>Para:</label>
                            <select id="transferPara">
                                <option value="">Escolha...</option>
                                <option value="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266">üë®‚Äçüè´ Professor</option>
                                <option value="0x70997970C51812dc3A010C7d01b50e0d17dc79C8">üë®‚Äçüéì Aluno 1</option>
                                <option value="0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC">üë©‚Äçüéì Aluno 2</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Quantidade:</label>
                            <input type="number" id="quantidadeTransfer" placeholder="5" min="1">
                        </div>
                        <button class="btn" onclick="transferirTokens()">üí∏ Transferir</button>
                    </div>
                </div>
            </div>

            <!-- VERIFICA√á√ÉO (TODOS) -->
            <div class="card">
                <h2>üîç Verificar Certificado</h2>
                <div class="input-group">
                    <label>ID do Certificado:</label>
                    <input type="text" id="verificarId" placeholder="CERT001">
                </div>
                <button class="btn" onclick="verificarCertificado()">üîç Verificar</button>
                <div id="verificacaoResult"></div>
            </div>

            <!-- EXEMPLO R√ÅPIDO -->
            <div class="card">
                <h2>‚ö° Exemplo R√°pido</h2>
                <button class="btn" onclick="exemploCompleto()">üéØ Demonstra√ß√£o</button>
                <button class="btn" onclick="atualizarSaldos()">üí∞ Atualizar Saldos</button>
            </div>
        </div>

        <div id="statusMessages"></div>
    </div>

    <script>
        // Endere√ßos dos contratos
        const CERTIFICADOS_ADDRESS = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";
        const CERTITOKEN_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";

        // Contas locais do Hardhat
        const ACCOUNTS = {
            admin: {
                address: "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
                name: "üë®‚Äçüè´ Professor",
                privateKey: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
            },
            aluno1: {
                address: "0x70997970C51812dc3A010C7d01b50e0d17dc79C8",
                name: "üë®‚Äçüéì Aluno 1",
                privateKey: "0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d"
            },
            aluno2: {
                address: "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC",
                name: "üë©‚Äçüéì Aluno 2",
                privateKey: "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a"
            }
        };

        // ABIs
        const CERTIFICADOS_ABI = [
            "function emitir(address aluno, string nome, string curso, string data, string id)",
            "function consultar(address aluno) view returns (tuple(string nome, string curso, string data, string id, bool ativo)[])",
            "function verificar(string id) view returns (bool)",
            "function detalhes(string id) view returns (string nome, string curso, string data, address aluno, bool ativo)"
        ];

        const CERTITOKEN_ABI = [
            "function balanceOf(address account) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)"
        ];

        let provider, currentUser, currentWallet, certificadosContract, certiTokenContract;

        // Conectar ao Hardhat local
        async function initProvider() {
            provider = new ethers.providers.JsonRpcProvider("http://127.0.0.1:8545");
        }

        // Selecionar usu√°rio
        async function selectUser(userType) {
            await initProvider();
            
            currentUser = ACCOUNTS[userType];
            currentWallet = new ethers.Wallet(currentUser.privateKey, provider);

            certificadosContract = new ethers.Contract(CERTIFICADOS_ADDRESS, CERTIFICADOS_ABI, currentWallet);
            certiTokenContract = new ethers.Contract(CERTITOKEN_ADDRESS, CERTITOKEN_ABI, currentWallet);

            // Atualizar UI
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAddress').textContent = currentUser.address;
            
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('hidden');

            // Mostrar painel apropriado
            document.getElementById('adminPanel').classList.toggle('hidden', userType !== 'admin');
            document.getElementById('studentPanel').classList.toggle('hidden', userType === 'admin');

            // Destacar bot√£o
            document.querySelectorAll('.user-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            await updateBalance();
            showStatus(`‚úÖ Conectado como ${currentUser.name}`, 'success');
        }

        // Atualizar saldo
        async function updateBalance() {
            try {
                const balance = await certiTokenContract.balanceOf(currentUser.address);
                const formatted = ethers.utils.formatEther(balance);
                document.getElementById('tokenBalance').textContent = parseFloat(formatted).toFixed(2);
            } catch (error) {
                console.error('Erro saldo:', error);
            }
        }

        // Emitir certificado
        async function emitirCertificado() {
            const alunoAddress = document.getElementById('selectAluno').value;
            const nome = document.getElementById('alunoNome').value;
            const curso = document.getElementById('cursoNome').value;
            const data = document.getElementById('cursoData').value;
            const id = document.getElementById('certificadoId').value;

            if (!alunoAddress || !nome || !curso || !data || !id) {
                showStatus('‚ùå Preencha todos os campos!', 'error');
                return;
            }

            try {
                showStatus('‚è≥ Emitindo certificado...', 'info');
                const tx = await certificadosContract.emitir(alunoAddress, nome, curso, data, id);
                await tx.wait();
                
                showStatus(`‚úÖ Certificado ${id} emitido! Aluno recebeu 10 CTK.`, 'success');
                
                // Limpar campos
                document.getElementById('selectAluno').value = '';
                document.getElementById('alunoNome').value = '';
                document.getElementById('cursoNome').value = '';
                document.getElementById('cursoData').value = '';
                document.getElementById('certificadoId').value = '';

            } catch (error) {
                showStatus('‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Consultar certificados
        async function consultarCertificados() {
            try {
                const certificados = await certificadosContract.consultar(currentUser.address);
                const resultDiv = document.getElementById('certificadosResult');
                
                if (certificados.length === 0) {
                    resultDiv.innerHTML = '<p>üì≠ Nenhum certificado encontrado.</p>';
                    return;
                }

                let html = '<h3>Seus Certificados:</h3>';
                certificados.forEach((cert, index) => {
                    html += `
                        <div class="certificate-card">
                            <h4>üéì Certificado #${index + 1}</h4>
                            <p><strong>Nome:</strong> ${cert.nome}</p>
                            <p><strong>Curso:</strong> ${cert.curso}</p>
                            <p><strong>Data:</strong> ${cert.data}</p>
                            <p><strong>ID:</strong> ${cert.id}</p>
                            <p><strong>Status:</strong> ${cert.ativo ? '‚úÖ Ativo' : '‚ùå Inativo'}</p>
                        </div>
                    `;
                });
                
                resultDiv.innerHTML = html;

            } catch (error) {
                showStatus('‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Verificar certificado
        async function verificarCertificado() {
            const id = document.getElementById('verificarId').value;
            if (!id) {
                showStatus('‚ùå Digite o ID!', 'error');
                return;
            }

            try {
                const existe = await certificadosContract.verificar(id);
                const resultDiv = document.getElementById('verificacaoResult');
                
                if (existe) {
                    const detalhes = await certificadosContract.detalhes(id);
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>‚úÖ Certificado V√°lido!</strong><br>
                            <strong>Nome:</strong> ${detalhes[0]}<br>
                            <strong>Curso:</strong> ${detalhes[1]}<br>
                            <strong>Data:</strong> ${detalhes[2]}<br>
                            <strong>Aluno:</strong> ${detalhes[3]}<br>
                            <strong>Status:</strong> ${detalhes[4] ? 'Ativo' : 'Inativo'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status error">
                            <strong>‚ùå Certificado n√£o encontrado!</strong>
                        </div>
                    `;
                }
            } catch (error) {
                showStatus('‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Transferir tokens
        async function transferirTokens() {
            const para = document.getElementById('transferPara').value;
            const quantidade = document.getElementById('quantidadeTransfer').value;

            if (!para || !quantidade) {
                showStatus('‚ùå Preencha os campos!', 'error');
                return;
            }

            try {
                showStatus('‚è≥ Transferindo...', 'info');
                const amount = ethers.utils.parseEther(quantidade);
                const tx = await certiTokenContract.transfer(para, amount);
                await tx.wait();
                
                showStatus(`‚úÖ ${quantidade} CTK transferidos!`, 'success');
                await updateBalance();
                
                document.getElementById('transferPara').value = '';
                document.getElementById('quantidadeTransfer').value = '';

            } catch (error) {
                showStatus('‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Exemplo completo
        async function exemploCompleto() {
            showStatus('üéØ Executando exemplo...', 'info');
            
            const adminWallet = new ethers.Wallet(ACCOUNTS.admin.privateKey, provider);
            const adminCertificados = new ethers.Contract(CERTIFICADOS_ADDRESS, CERTIFICADOS_ABI, adminWallet);
            
            try {
                await adminCertificados.emitir(
                    ACCOUNTS.aluno1.address,
                    "Jo√£o Exemplo", 
                    "Demonstra√ß√£o Blockchain",
                    "2025-01-15",
                    "DEMO001"
                );

                showStatus('‚úÖ Exemplo conclu√≠do! Certificado DEMO001 emitido.', 'success');
                
            } catch (error) {
                showStatus('‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Atualizar saldos
        async function atualizarSaldos() {
            if (currentUser) {
                await updateBalance();
                showStatus('üí∞ Saldo atualizado!', 'info');
            }
        }

        // Mostrar status
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessages');
            const statusEl = document.createElement('div');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
            
            statusDiv.appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.remove();
            }, 4000);
        }

        // Definir data de hoje
        document.addEventListener('DOMContentLoaded', function() {
            const hoje = new Date().toISOString().split('T')[0];
            if (document.getElementById('cursoData')) {
                document.getElementById('cursoData').value = hoje;
            }
        });
    </script>
</body>
</html> 